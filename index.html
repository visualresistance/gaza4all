<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>gaza4all — compare & learn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Draggable polygons -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet.path.drag@0.0.6/src/Path.Drag.js"></script>

  <!-- Turf.js for geodesic area -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Config (paths, presets, start view) -->
  <script src="config.js"></script>

  <style>
    :root {
      --panel-w: 340px;         /* right sidebar width */
      --border: #e5e7eb;
      --shadow: 0 2px 10px rgba(0,0,0,.08);
      --pal-green: 0,122,61;    /* Palestine green (~#007A3D) */
    }
    html, body, #map { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }

    /* Slim vertical control bar (left) */
    .controls {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      width: 220px;
      background: rgba(var(--pal-green), 0.10);
      border: 1px solid rgba(var(--pal-green), 0.28);
      border-radius: 12px;
      padding: 10px;
      display: flex; flex-direction: column; gap: 8px;
      box-shadow: var(--shadow);
      backdrop-filter: saturate(120%) blur(1px);
    }
    .controls h4 {
      margin: 0 0 2px; font-size: 13px; font-weight: 700; letter-spacing: .2px; color: #064e3b;
    }
    .btn {
      cursor: pointer; padding: 7px 10px;
      border-radius: 9px; border: 1px solid rgba(0,0,0,0.15); background: #fff;
      font-size: 13px; text-align: left;
    }
    .btn:hover { background: #f6f6f6; }
    .row { display: flex; flex-direction: column; gap: 6px; }
    .small { font-size: 11px; color: #1f2937; }

    select {
      width: 100%; padding: 7px 10px;
      border-radius: 9px; border: 1px solid rgba(0,0,0,0.15); background: #fff; font-size: 13px;
    }

    .status { font-size: 11px; color: #374151; padding-top: 2px; }

    /* Right sidebar toggle */
    body.sidebar-hidden .sidebar { display: none; }
    body.sidebar-hidden .info-pill { right: 10px; }

    /* Left controls hide/show */
    body.controls-hidden .controls { display: none; }
    #showControlsBtn {
      position: absolute; z-index: 1001; left: 10px; bottom: 10px;
      display: none;
      background: rgba(255,255,255,0.95); border: 1px solid var(--border); border-radius: 8px;
      padding: 6px 10px; font-size: 13px; cursor: pointer; box-shadow: var(--shadow);
    }
    body.controls-hidden #showControlsBtn { display: block; }

    /* Area pill */
    .info-pill {
      position: absolute; z-index: 1000; top: 10px; right: calc(var(--panel-w) + 20px);
      background: rgba(255,255,255,0.96); border: 1px solid var(--border); border-radius: 10px;
      padding: 8px 10px; font-size: 12px; box-shadow: var(--shadow); min-width: 180px;
    }
    .info-pill .name { font-weight: 600; }
    .info-pill .num { font-variant-numeric: tabular-nums; }

    /* Right sidebar (tabs only) */
    .sidebar {
      position: absolute; z-index: 1000; top: 0; right: 0; height: 100%; width: var(--panel-w);
      background: #fff; border-left: 1px solid var(--border); display: flex; flex-direction: column;
      box-shadow: -6px 0 20px rgba(0,0,0,.06);
    }
    .sidebar-header {
      display: flex; align-items: center; justify-content: flex-start; gap: 6px; padding: 10px 12px;
      border-bottom: 1px solid var(--border); background: #fafafa;
    }
    .tab-btn {
      border: 1px solid #d1d5db; background: #fff; padding: 6px 10px; border-radius: 16px; font-size: 12px; cursor: pointer;
    }
    .tab-btn.active { background: #111; color: #fff; border-color: #111; }
    .sidebar-body { padding: 12px; overflow: auto; }
    .sidebar-body h1, .sidebar-body h2, .sidebar-body h3, .sidebar-body h4 { margin: 10px 0 6px; }
    .sidebar-body p, .sidebar-body li { font-size: 13px; line-height: 1.45; }
    .sidebar-body a { color: #111; }

    /* Splash overlay */
    .splash-overlay {
      position: fixed; inset: 0; z-index: 1600; background: rgba(0,0,0,0.5);
      display: none; align-items: center; justify-content: center; padding: 16px;
    }
    .splash-overlay.show { display: flex; }
    .splash-card {
      background: #ffffff; border-radius: 14px; border: 1px solid var(--border);
      max-width: 720px; width: 100%; box-shadow: 0 14px 40px rgba(0,0,0,0.22);
      padding: 18px 18px 14px;
    }
    .splash-head { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .splash-title { font-size: 18px; font-weight: 700; margin: 0; }
    .splash-close { background:#111; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
    .splash-body { font-size: 14px; line-height: 1.5; }
    .splash-body img { max-width: 100%; height: auto; border-radius: 8px; margin: 6px 0 10px; }

    @media (max-width: 680px) {
      .controls { width: 190px; }
      .info-pill { right: 10px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Slim vertical control bar -->
  <div class="controls">
    <h4>Controls</h4>
    <div class="row">
      <button class="btn" id="btnGaza">Add Gaza here</button>
      <button class="btn" id="btnWB">Add West Bank here</button>
      <button class="btn" id="btnPOI">Load Schools & Libraries (in view)</button>
      <select id="presetSelect" title="Jump to a city preset">
        <option value="">— Jump to a city —</option>
      </select>
      <button class="btn" id="toggleSidebar" title="Show/Hide right panel">Full Map</button>
      <button class="btn" id="hideControls" title="Hide left control bar">Hide buttons</button>
    </div>
    <div class="status" id="status">Ready</div>
  </div>

  <!-- Tiny reveal button when controls hidden -->
  <button id="showControlsBtn" aria-pressed="false">Show sidebar</button>

  <!-- Area info -->
  <div class="info-pill" id="infoPill" style="display:none;">
    <div><span class="name" id="pillName">—</span></div>
    <div>Geodesic area: <span class="num" id="pillArea">—</span> km²</div>
  </div>

  <!-- Right sidebar (tabs only) -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="tab-btn active" data-tab="about">About</button>
      <button class="tab-btn" data-tab="data">Data</button>
      <button class="tab-btn" data-tab="resources">Resources</button>
    </div>
    <div class="sidebar-body" id="sidebarBody"></div>
  </aside>

  <!-- Splash -->
  <div class="splash-overlay" id="splash">
    <div class="splash-card">
      <div class="splash-head">
        <h3 class="splash-title">Welcome</h3>
        <button class="splash-close" id="splashClose">Enter map</button>
      </div>
      <div class="splash-body" id="splashBody"><!-- markdown goes here --></div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const CFG = window.GAZA4ALL_CONFIG || {};
    const START_CENTER = (CFG.start && Array.isArray(CFG.start.center)) ? CFG.start.center : [34.0522, -118.2437];
    const START_ZOOM   = (CFG.start && CFG.start.zoom) ? CFG.start.zoom : 11;

    // Markdown paths (future-proof merge with defaults)
    const DEFAULT_MD = {
      about:     'content/about.md',
      data:      'content/data.md',
      resources: 'content/resources.md',
      readme:    'content/readme.md',
      splash:    'content/splash.md'
    };
    const MD = { ...DEFAULT_MD, ...(CFG.md || {}) };

    // Repo (for GeoJSON) — allows overrides via config.js
    const OWNER  = (CFG.repo && CFG.repo.owner)  || 'visualresistance';
    const REPO   = (CFG.repo && CFG.repo.name)   || 'gaza4all';
    const BRANCH = (CFG.repo && CFG.repo.branch) || 'main';
    const GAZA_URL = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/data/gaza.geojson`;
    const WB_URL   = `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/data/west_bank.geojson`;

    // === Map ===
    const map = L.map('map').setView(START_CENTER, START_ZOOM);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const layerControl = L.control.layers({ "OpenStreetMap": osm }, {}, { collapsed:false }).addTo(map);

    // Right sidebar toggle (Full Map ↔ Show Sidebar)
    const toggleBtn = document.getElementById('toggleSidebar');
    if (localStorage.getItem('sidebarHidden') === 'true') {
      document.body.classList.add('sidebar-hidden');
      toggleBtn.textContent = 'Show Sidebar';
      toggleBtn.setAttribute('aria-pressed','true');
    } else {
      toggleBtn.textContent = 'Full Map';
      toggleBtn.setAttribute('aria-pressed','false');
    }
    toggleBtn.addEventListener('click', () => {
      const hidden = document.body.classList.toggle('sidebar-hidden');
      toggleBtn.textContent = hidden ? 'Show Sidebar' : 'Full Map';
      toggleBtn.setAttribute('aria-pressed', hidden ? 'true' : 'false');
      localStorage.setItem('sidebarHidden', hidden ? 'true' : 'false');
      requestAnimationFrame(() => map.invalidateSize());
    });

    // Left controls hide/show
    const hideControls = document.getElementById('hideControls');
    const showControlsBtn = document.getElementById('showControlsBtn');

    if (localStorage.getItem('controlsHidden') === 'true') {
      document.body.classList.add('controls-hidden');
      showControlsBtn.setAttribute('aria-pressed','true');
    }
    hideControls.addEventListener('click', () => {
      document.body.classList.add('controls-hidden');
      localStorage.setItem('controlsHidden', 'true');
      showControlsBtn.setAttribute('aria-pressed','true');
      requestAnimationFrame(() => map.invalidateSize());
    });
    showControlsBtn.addEventListener('click', () => {
      document.body.classList.remove('controls-hidden');
      localStorage.setItem('controlsHidden', 'false');
      showControlsBtn.setAttribute('aria-pressed','false');
      requestAnimationFrame(() => map.invalidateSize());
    });

    // Templates + active layers
    let gazaTemplate=null, wbTemplate=null;
    let gazaLayer=null, wbLayer=null;
    const STYLE_GAZA = { color:'#ef4444', weight:2, fillOpacity:0.15 };
    const STYLE_WB   = { color:'#3b82f6', weight:2, fillOpacity:0.15 };

    // POI overlay
    const poiLayer = L.layerGroup();
    layerControl.addOverlay(poiLayer, "Schools & Libraries (OSM)");

    // Status
    const statusEl = document.getElementById('status');
    const setStatus = (m,err=false)=>{ statusEl.textContent=m; statusEl.style.color = err ? '#b00020' : '#374151'; };

    // Area pill
    const pill = document.getElementById('infoPill');
    const pillName = document.getElementById('pillName');
    const pillArea = document.getElementById('pillArea');
    function showAreaPill(name, fc){
      try {
        const area_km2 = turf.area(fc) / 1e6;
        pillName.textContent = name;
        pillArea.textContent = area_km2.toFixed(1);
        pill.style.display = 'block';
      } catch(e){
        pillName.textContent = name; pillArea.textContent = '—'; pill.style.display = 'block';
      }
    }

    // Fetch helpers
    async function fetchJSON(url){
      const r = await fetch(url, { cache:'no-store' });
      if(!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`);
      const t = await r.text();
      try { return JSON.parse(t); } catch { throw new Error(`Non-JSON @ ${url}: ${t.slice(0,120)}`); }
    }
    async function fetchMD(path){
      const r = await fetch(path, { cache:'no-store' });
      if(!r.ok) throw new Error(`HTTP ${r.status} @ ${path}`);
      return r.text();
    }
    async function ensureTemplates(){
      if(!gazaTemplate){ setStatus('Loading Gaza…'); gazaTemplate = await fetchJSON(GAZA_URL); }
      if(!wbTemplate){   setStatus('Loading West Bank…'); wbTemplate = await fetchJSON(WB_URL); }
      setStatus('Ready');
    }

    // EPSG:3857 translation
    function getCenterLatLng(fc){
      const tmp=L.geoJSON(fc); const c=tmp.getBounds().getCenter(); tmp.remove(); return c;
    }
    function translateFC_3857(fc, dx_m, dy_m){
      const crs = map.options.crs; // EPSG:3857
      const out = JSON.parse(JSON.stringify(fc));
      function shiftCoord([lng,lat]){
        const p = crs.project(L.latLng(lat, lng));
        const ll = crs.unproject(L.point(p.x + dx_m, p.y + dy_m));
        return [ll.lng, ll.lat];
      }
      function shiftRings(coords){
        if (typeof coords[0][0] === 'number') return coords.map(shiftCoord);
        return coords.map(shiftRings);
      }
      out.features = out.features.map(feat=>{
        const g = feat.geometry;
        if (g.type === 'Polygon' || g.type === 'MultiPolygon') g.coordinates = shiftRings(g.coordinates);
        return feat;
      });
      return out;
    }
    function geojsonToLayerDraggable(fc, style){
      const layer = L.geoJSON(fc, { style });
      layer.on('add', () => {
        layer.eachLayer(l => { if (l.dragging && typeof l.dragging.enable === 'function') l.dragging.enable(); });
      });
      return layer;
    }
    function placeAtCenter_3857(templateFC, style){
      const mapC = map.getCenter();
      const tplC = getCenterLatLng(templateFC);
      const crs = map.options.crs;
      const mapP = crs.project(mapC);
      const tplP = crs.project(tplC);
      const moved = translateFC_3857(templateFC, mapP.x - tplP.x, mapP.y - tplP.y);
      return geojsonToLayerDraggable(moved, style).addTo(map);
    }

    // Buttons: Gaza / WB
    document.getElementById('btnGaza').addEventListener('click', async ()=>{
      try {
        await ensureTemplates();
        if (gazaLayer) map.removeLayer(gazaLayer);
        gazaLayer = placeAtCenter_3857(gazaTemplate, STYLE_GAZA);
        layerControl.addOverlay(gazaLayer, 'Gaza (draggable)');
        setStatus('Gaza placed');
        showAreaPill('Gaza', gazaTemplate);
      } catch(e){ setStatus('Failed to load Gaza: '+e.message, true); alert(e.message); }
    });
    document.getElementById('btnWB').addEventListener('click', async ()=>{
      try {
        await ensureTemplates();
        if (wbLayer) map.removeLayer(wbLayer);
        wbLayer = placeAtCenter_3857(wbTemplate, STYLE_WB);
        layerControl.addOverlay(wbLayer, 'West Bank (draggable)');
        setStatus('West Bank placed');
        showAreaPill('West Bank', wbTemplate);
      } catch(e){ setStatus('Failed to load West Bank: '+e.message, true); alert(e.message); }
    });

    // POI
    document.getElementById('btnPOI').addEventListener('click', async ()=>{
      const b = map.getBounds();
      const bbox = [b.getSouth(), b.getWest(), b.getNorth(), b.getEast()].join(',');
      const query = `
        [out:json][timeout:25];
        ( node["amenity"="school"](${bbox}); way["amenity"="school"](${bbox}); relation["amenity"="school"](${bbox});
          node["amenity"="library"](${bbox}); way["amenity"="library"](${bbox}); relation["amenity"="library"](${bbox}); );
        out center;`;
      try {
        const data = await fetch('https://overpass-api.de/api/interpreter', {
          method:'POST', body:query, headers:{'Content-Type':'text/plain;charset=UTF-8'}
        }).then(r=>r.json());

        poiLayer.clearLayers();
        let n=0;
        for (const el of data.elements) {
          let lat=el.lat, lon=el.lon;
          if (!lat && el.center) { lat=el.center.lat; lon=el.center.lon; }
          if (lat && lon) {
            const name=el.tags?.name||'(unnamed)'; const type=el.tags?.amenity||'';
            L.circleMarker([lat,lon], {radius:4}).bindPopup(`<b>${name}</b><br>${type}`).addTo(poiLayer); n++;
          }
        }
        if (n===0) return alert('No schools/libraries found in view. Zoom in and try again.');
        poiLayer.addTo(map);
        setStatus(`Loaded ${n} POI`);
      } catch(e){ setStatus('POI load failed: '+e.message, true); alert(e.message); }
    });

    // Presets
    const presetSel = document.getElementById('presetSelect');
    (CFG.presets || []).forEach((p,i)=>{
      const opt = document.createElement('option');
      opt.value = i; opt.textContent = p.name;
      presetSel.appendChild(opt);
    });
    presetSel.addEventListener('change', e=>{
      const idx = e.target.value;
      if (idx === '') return;
      const p = (CFG.presets || [])[idx];
      if (p && Array.isArray(p.center)) map.setView(p.center, p.zoom || 11);
    });

    // Sidebar (Markdown loader)
    const sidebarBody = document.getElementById('sidebarBody');
    const tabs = document.querySelectorAll('.tab-btn');
    async function renderTab(tab){
      tabs.forEach(t => t.classList.toggle('active', t.dataset.tab===tab));
      const path = (tab==='about') ? MD.about : (tab==='data') ? MD.data : MD.resources;
      try {
        const md = await fetchMD(path);
        sidebarBody.innerHTML = marked.parse(md);
      } catch (e) {
        sidebarBody.innerHTML = `<p style="color:#b00020;">Failed to load ${path}: ${e.message}</p>`;
      }
    }
    tabs.forEach(btn => btn.addEventListener('click', ()=> renderTab(btn.dataset.tab)));
    renderTab('about'); // initial

    // Splash (Markdown + optional image)
    const splash = document.getElementById('splash');
    const splashBody = document.getElementById('splashBody');
    const splashClose = document.getElementById('splashClose');

    function openSplash(){
      splash.classList.add('show');
      splash.setAttribute('aria-hidden','false');
    }
    function closeSplash(){
      splash.classList.remove('show');
      splash.setAttribute('aria-hidden','true');
    }
    splashClose.addEventListener('click', closeSplash);
    splash.addEventListener('click', (e)=>{ if(e.target === splash) closeSplash(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeSplash(); });

    (async ()=>{
      try {
        const md = await fetchMD(MD.splash || DEFAULT_MD.splash);
        splashBody.innerHTML = marked.parse(md);
      } catch (e) {
        splashBody.innerHTML = `<p style="color:#b00020;">Failed to load ${MD.splash || DEFAULT_MD.splash}: ${e.message}</p>`;
      }
      // Show on first visit OR if URL has ?splash=1
      const forceSplash = /(?:\\?|&)splash=1\\b/.test(location.search);
      if (forceSplash || !localStorage.getItem('splashShown')) {
        openSplash();
        if (!forceSplash) localStorage.setItem('splashShown','true');
      }
    })();

    console.log('Using RAW URLs:', GAZA_URL, WB_URL);
  </script>
</body>
</html>


