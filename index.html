<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>gaza4all — size compare (accurate move + area)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Draggable polygons -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet.path.drag@0.0.6/src/Path.Drag.js"></script>

  <!-- Turf.js for geodesic area -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .controls {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: rgba(255,255,255,0.95); border: 1px solid #ddd; border-radius: 8px;
      padding: 8px; display: grid; gap: 6px; font-family: system-ui, sans-serif;
      max-width: 360px;
    }
    button {
      cursor: pointer; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff;
    }
    button:hover { background: #f6f6f6; }
    .status { font-size: 12px; color: #444; }
    .error { color: #b00020; }

    /* Area info pill */
    .info-pill {
      position: absolute; z-index: 1000; top: 10px; right: 10px;
      background: rgba(255,255,255,0.96); border: 1px solid #ddd; border-radius: 8px;
      padding: 8px 10px; font-family: system-ui, sans-serif; font-size: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08); min-width: 180px;
    }
    .info-pill .name { font-weight: 600; }
    .info-pill .num { font-variant-numeric: tabular-nums; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      display: none; align-items: center; justify-content: center; z-index: 1500;
      padding: 16px;
    }
    .modal-overlay.show { display: flex; }
    .modal-card {
      background: #ffffff; border-radius: 12px; border: 1px solid #e5e7eb;
      max-width: 560px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      padding: 18px 16px 14px;
    }
    .modal-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;
    }
    .modal-title { font-size: 16px; font-weight: 600; margin: 0; }
    .modal-close {
      background: transparent; border: none; font-size: 18px; line-height: 1; cursor: pointer; padding: 4px 8px;
    }
    .modal-body { font-size: 14px; color: #222; line-height: 1.45; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <button id="btnReadme">ReadMe</button>
    <button id="btnGaza">Add Gaza here</button>
    <button id="btnWB">Add West Bank here</button>
    <button id="btnPOI">Load Schools & Libraries (in view)</button>
    <div class="status" id="status">Ready</div>
  </div>

  <!-- Area info -->
  <div class="info-pill" id="infoPill" style="display:none;">
    <div><span class="name" id="pillName">—</span></div>
    <div>Geodesic area: <span class="num" id="pillArea">—</span> km²</div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="readmeModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal-card" role="document">
      <div class="modal-header">
        <h3 class="modal-title">About this map</h3>
        <button class="modal-close" id="modalClose" aria-label="Close">✕</button>
      </div>
      <div class="modal-body">
This map is meant for you to get a better sense of the size of Gaza and the West Bank. The ongoing destruction of Gaza and the genocide and displacement of Palestinians is unimaginable. Try for a moment to see yourself in Gaza
      </div>
    </div>
  </div>

  <script>
    // === Map (Los Angeles) ===
    const map = L.map('map').setView([34.0522, -118.2437], 11);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const layerControl = L.control.layers({ "OpenStreetMap": osm }, {}, { collapsed:false }).addTo(map);

    // === RAW URLs from your public repo ===
    const GAZA_URL = 'https://raw.githubusercontent.com/visualresistance/gaza4all/main/data/gaza.geojson';
    const WB_URL   = 'https://raw.githubusercontent.com/visualresistance/gaza4all/main/data/west_bank.geojson';

    // Templates + active layers
    let gazaTemplate=null, wbTemplate=null;
    let gazaLayer=null, wbLayer=null;

    // Styles
    const STYLE_GAZA = { color:'#ef4444', weight:2, fillOpacity:0.15 };
    const STYLE_WB   = { color:'#3b82f6', weight:2, fillOpacity:0.15 };

    // POI overlay
    const poiLayer = L.layerGroup();
    layerControl.addOverlay(poiLayer, "Schools & Libraries (OSM)");

    // Status helper
    const statusEl = document.getElementById('status');
    const setStatus = (m,err=false)=>{ statusEl.textContent=m; statusEl.className='status'+(err?' error':''); };

    // Area pill helpers
    const pill = document.getElementById('infoPill');
    const pillName = document.getElementById('pillName');
    const pillArea = document.getElementById('pillArea');
    function showAreaPill(name, fc){
      try {
        const area_m2 = turf.area(fc);                 // geodesic area on WGS84
        const area_km2 = area_m2 / 1e6;
        pillName.textContent = name;
        pillArea.textContent = area_km2.toFixed(1);
        pill.style.display = 'block';
      } catch(e){
        pillName.textContent = name;
        pillArea.textContent = '—';
        pill.style.display = 'block';
      }
    }

    // Fetch JSON robustly
    async function fetchJSON(url){
      const r = await fetch(url, { cache:'no-store' });
      if(!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`);
      const t = await r.text();
      try { return JSON.parse(t); }
      catch { throw new Error(`Non-JSON from ${url}. First 120 chars: ${t.slice(0,120)}`); }
    }
    async function ensureTemplates(){
      if(!gazaTemplate){ setStatus('Loading Gaza…'); gazaTemplate = await fetchJSON(GAZA_URL); }
      if(!wbTemplate){   setStatus('Loading West Bank…'); wbTemplate = await fetchJSON(WB_URL); }
      setStatus('Ready');
    }

    // === Geometry helpers ===
    // Get geodesic center (via bounds)
    function getCenterLatLng(fc){
      const tmp=L.geoJSON(fc); const c=tmp.getBounds().getCenter(); tmp.remove(); return c;
    }

    // Translate a FeatureCollection by a delta in EPSG:3857 meters
    function translateFC_3857(fc, dx_m, dy_m){
      const crs = map.options.crs; // EPSG:3857
      const out = JSON.parse(JSON.stringify(fc));

      function shiftCoord(coord){ // [lng,lat] => shift in meters then back
        const latlng = L.latLng(coord[1], coord[0]);
        const p = crs.project(latlng);      // {x,y} in meters
        const p2 = L.point(p.x + dx_m, p.y + dy_m);
        const ll2 = crs.unproject(p2);      // back to lat/lng
        return [ll2.lng, ll2.lat];
      }
      function shiftRings(coords){
        if (typeof coords[0][0] === 'number') {
          return coords.map(shiftCoord);            // LinearRing
        } else {
          return coords.map(shiftRings);           // array of rings / polygons
        }
      }

      out.features = out.features.map(feat=>{
        const g = feat.geometry;
        if (g.type === 'Polygon' || g.type === 'MultiPolygon') {
          g.coordinates = shiftRings(g.coordinates);
        } else if (g.type === 'MultiLineString' || g.type === 'LineString') {
          g.coordinates = Array.isArray(g.coordinates[0][0])
            ? g.coordinates.map(r => r.map(shiftCoord))
            : g.coordinates.map(shiftCoord);
        }
        return feat;
      });

      return out;
    }

    // Create a draggable Leaflet layer (enable dragging AFTER add)
    function geojsonToLayerDraggable(fc, style){
      const layer = L.geoJSON(fc, { style });
      layer.on('add', () => {
        layer.eachLayer(l => { if (l.dragging && typeof l.dragging.enable === 'function') l.dragging.enable(); });
      });
      return layer;
    }

    // Place template at current map center using 3857-meter translation
    function placeAtCenter_3857(templateFC, style){
      const mapC = map.getCenter();
      const tplC = getCenterLatLng(templateFC);

      const crs = map.options.crs;
      const mapP = crs.project(mapC);
      const tplP = crs.project(tplC);
      const dx = mapP.x - tplP.x; // meters in 3857
      const dy = mapP.y - tplP.y;

      const moved = translateFC_3857(templateFC, dx, dy);
      return geojsonToLayerDraggable(moved, style).addTo(map);
    }

    // === Buttons ===
    document.getElementById('btnGaza').addEventListener('click', async ()=>{
      try {
        await ensureTemplates();
        if (gazaLayer) map.removeLayer(gazaLayer);
        gazaLayer = placeAtCenter_3857(gazaTemplate, STYLE_GAZA);
        layerControl.addOverlay(gazaLayer, 'Gaza (draggable)');
        setStatus('Gaza placed');
        showAreaPill('Gaza', gazaTemplate);   // show true geodesic area from the source geometry
      } catch(e){ setStatus('Failed to load Gaza: '+e.message, true); alert(e.message); }
    });

    document.getElementById('btnWB').addEventListener('click', async ()=>{
      try {
        await ensureTemplates();
        if (wbLayer) map.removeLayer(wbLayer);
        wbLayer = placeAtCenter_3857(wbTemplate, STYLE_WB);
        layerControl.addOverlay(wbLayer, 'West Bank (draggable)');
        setStatus('West Bank placed');
        showAreaPill('West Bank', wbTemplate);
      } catch(e){ setStatus('Failed to load West Bank: '+e.message, true); alert(e.message); }
    });

    document.getElementById('btnPOI').addEventListener('click', async ()=>{
      const b = map.getBounds();
      const bbox = [b.getSouth(), b.getWest(), b.getNorth(), b.getEast()].join(',');
      const query = `
        [out:json][timeout:25];
        ( node["amenity"="school"](${bbox}); way["amenity"="school"](${bbox}); relation["amenity"="school"](${bbox});
          node["amenity"="library"](${bbox}); way["amenity"="library"](${bbox}); relation["amenity"="library"](${bbox}); );
        out center;`;
      try {
        const data = await fetch('https://overpass-api.de/api/interpreter', {
          method:'POST', body:query, headers:{'Content-Type':'text/plain;charset=UTF-8'}
        }).then(r=>r.json());

        poiLayer.clearLayers();
        let n=0;
        for (const el of data.elements) {
          let lat=el.lat, lon=el.lon;
          if (!lat && el.center) { lat=el.center.lat; lon=el.center.lon; }
          if (lat && lon) {
            const name=el.tags?.name||'(unnamed)'; const type=el.tags?.amenity||'';
            L.circleMarker([lat,lon], {radius:4}).bindPopup(`<b>${name}</b><br>${type}`).addTo(poiLayer); n++;
          }
        }
        if (n===0) return alert('No schools/libraries found in view. Zoom in and try again.');
        poiLayer.addTo(map);
        setStatus(`Loaded ${n} POI`);
      } catch(e){ setStatus('POI load failed: '+e.message, true); alert(e.message); }
    });

    // === Modal wiring ===
    const modal = document.getElementById('readmeModal');
    const btnReadme = document.getElementById('btnReadme');
    const btnClose = document.getElementById('modalClose');

    function openModal(){ modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
    function closeModal(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

    btnReadme.addEventListener('click', openModal);
    btnClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

    // Auto-open once per visitor, but can be reopened via the ReadMe button
    if (!localStorage.getItem('readmeShown')) {
      openModal();
      localStorage.setItem('readmeShown', 'true');
    }

    console.log('Using RAW URLs:', GAZA_URL, WB_URL);
  </script>
</body>
</html>



  

