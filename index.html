<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>gaza4all — simple</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Make polygons draggable -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet.path.drag@0.0.6/src/Path.Drag.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .controls {
      position: absolute; z-index: 1000; top: 10px; left: 10px;
      background: rgba(255,255,255,0.95); border: 1px solid #ddd; border-radius: 8px;
      padding: 8px; display: grid; gap: 6px; font-family: system-ui, sans-serif;
      max-width: 320px;
    }
    button { cursor: pointer; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff; }
    button:hover { background: #f6f6f6; }
    .status { font-size: 12px; color: #444; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="controls">
    <button id="btnGaza">Add Gaza here</button>
    <button id="btnWB">Add West Bank here</button>
    <button id="btnPOI">Load Schools & Libraries (in view)</button>
    <div class="status" id="status">Ready</div>
  </div>

  <script>
    // === Map (start in Los Angeles) ===
    const map = L.map('map').setView([34.0522, -118.2437], 11);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const layerControl = L.control.layers({ "OpenStreetMap": osm }, {}, { collapsed: false }).addTo(map);

    // === RAW URLs (public) ===
    const GAZA_URL = 'https://raw.githubusercontent.com/visualresistance/gaza4all/main/data/gaza.geojson';
    const WB_URL   = 'https://raw.githubusercontent.com/visualresistance/gaza4all/main/data/west_bank.geojson';

    // Templates (original geometry from files)
    let gazaTemplate = null, wbTemplate = null;
    // Active layers placed on the map (draggable)
    let gazaLayer = null, wbLayer = null;

    const STYLE_GAZA = { color: '#ef4444', weight: 2, fillOpacity: 0.15 };
    const STYLE_WB   = { color: '#3b82f6', weight: 2, fillOpacity: 0.15 };

    // POI layer
    const poiLayer = L.layerGroup();
    layerControl.addOverlay(poiLayer, "Schools & Libraries (OSM)");

    const statusEl = document.getElementById('status');
    function setStatus(msg, isError=false) {
      statusEl.textContent = msg;
      statusEl.className = 'status' + (isError ? ' error' : '');
      console.log('[status]', msg);
    }

    // Robust fetch (parses even if server sets text/plain)
    async function fetchJSON(url) {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`);
      const txt = await r.text();
      try { return JSON.parse(txt); }
      catch (e) { throw new Error(`Non-JSON from ${url}. First 120 chars: ${txt.slice(0,120)}`); }
    }

    async function ensureTemplates() {
      if (!gazaTemplate) {
        setStatus('Loading Gaza…');
        gazaTemplate = await fetchJSON(GAZA_URL);
        setStatus('Loaded Gaza');
      }
      if (!wbTemplate) {
        setStatus('Loading West Bank…');
        wbTemplate = await fetchJSON(WB_URL);
        setStatus('Loaded West Bank');
      }
    }

    function geojsonToLayer(fc, style) {
      const layer = L.geoJSON(fc, {
        style,
        onEachFeature: (f, lyr) => {
          if (lyr.dragging) lyr.dragging.enable();
          lyr.on('dragstart', () => lyr.setStyle({ opacity: 0.8 }));
          lyr.on('dragend',   () => lyr.setStyle({ opacity: 1.0 }));
        }
      });
      layer.eachLayer(l => { if (l.dragging) l.dragging.enable(); });
      return layer;
    }

    function getCenter(fc) {
      const tmp = L.geoJSON(fc);
      const c = tmp.getBounds().getCenter();
      tmp.remove();
      return c;
    }

    // Translate (lon/lat order) by Δlat, Δlng
    function translateFC(fc, dLat, dLng) {
      const out = JSON.parse(JSON.stringify(fc));
      function shift(coords) {
        if (typeof coords[0][0] === 'number') {
          return coords.map(([lng,lat]) => [lng + dLng, lat + dLat]);
        } else {
          return coords.map(shift);
        }
      }
      out.features = out.features.map(feat => {
        const g = feat.geometry;
        if (g.type === 'Polygon' || g.type === 'MultiPolygon') g.coordinates = shift(g.coordinates);
        return feat;
      });
      return out;
    }

    function placeAtCenter(templateFC, style) {
      const mapC = map.getCenter();
      const tplC = getCenter(templateFC);
      const moved = translateFC(templateFC, mapC.lat - tplC.lat, mapC.lng - tplC.lng);
      return geojsonToLayer(moved, style).addTo(map);
    }

    // === Buttons ===
    document.getElementById('btnGaza').addEventListener('click', async () => {
      try {
        await ensureTemplates();
        if (gazaLayer) map.removeLayer(gazaLayer);
        gazaLayer = placeAtCenter(gazaTemplate, STYLE_GAZA);
        layerControl.addOverlay(gazaLayer, 'Gaza (draggable)');
        setStatus('Gaza placed at map center');
      } catch (e) {
        setStatus('Failed to load Gaza: ' + e.message, true);
        alert('Failed to load Gaza.\n\n' + e.message);
      }
    });

    document.getElementById('btnWB').addEventListener('click', async () => {
      try {
        await ensureTemplates();
        if (wbLayer) map.removeLayer(wbLayer);
        wbLayer = placeAtCenter(wbTemplate, STYLE_WB);
        layerControl.addOverlay(wbLayer, 'West Bank (draggable)');
        setStatus('West Bank placed at map center');
      } catch (e) {
        setStatus('Failed to load West Bank: ' + e.message, true);
        alert('Failed to load West Bank.\n\n' + e.message);
      }
    });

    document.getElementById('btnPOI').addEventListener('click', async () => {
      const b = map.getBounds();
      const bbox = [b.getSouth(), b.getWest(), b.getNorth(), b.getEast()].join(',');
      const query = `
        [out:json][timeout:25];
        (
          node["amenity"="school"](${bbox});
          way["amenity"="school"](${bbox});
          relation["amenity"="school"](${bbox});
          node["amenity"="library"](${bbox});
          way["amenity"="library"](${bbox});
          relation["amenity"="library"](${bbox});
        );
        out center;
      `;
      try {
        const data = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          body: query,
          headers: { 'Content-Type': 'text/plain;charset=UTF-8' }
        }).then(r => r.json());

        poiLayer.clearLayers();
        let count = 0;
        for (const el of data.elements) {
          let lat = el.lat, lon = el.lon;
          if (!lat && el.center) { lat = el.center.lat; lon = el.center.lon; }
          if (lat && lon) {
            const name = el.tags?.name || '(unnamed)';
            const type = el.tags?.amenity || '';
            L.circleMarker([lat, lon], { radius: 4 })
              .bindPopup(`<b>${name}</b><br>${type}`)
              .addTo(poiLayer);
            count++;
          }
        }
        if (count === 0) { alert('No schools/libraries found in current view. Try zooming in.'); return; }
        poiLayer.addTo(map); // visible; can toggle in layer control
        setStatus(`Loaded ${count} POI`);
      } catch (e) {
        setStatus('POI load failed: ' + e.message, true);
        alert('Overpass request failed.\n\n' + e.message);
      }
    });

    // Tip in the console so you can confirm what’s being fetched
    console.log('Fetching from RAW URLs:', GAZA_URL, WB_URL);
  </script>
</body>
</html>


  

