<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>gaza4all — simple</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet.path.drag@0.0.6/src/Path.Drag.js"></script>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .controls { position:absolute; z-index:1000; top:10px; left:10px; background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; display:grid; gap:6px; font-family:system-ui,sans-serif; }
    button { cursor:pointer; padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:#fff; }
    button:hover { background:#f6f6f6; }
    .status { font-size:12px; color:#444; }
    .error { color:#b00020; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="controls">
    <button id="btnGaza">Add Gaza here</button>
    <button id="btnWB">Add West Bank here</button>
    <button id="btnPOI">Load Schools & Libraries (in view)</button>
    <div class="status" id="status">Ready</div>
  </div>

  <script>
    const map = L.map('map').setView([34.0522, -118.2437], 11);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
    const layerControl = L.control.layers({ "OpenStreetMap": osm }, {}, { collapsed:false }).addTo(map);

    // ✅ Use your RAW URLs (public, CORS-friendly)
    const GAZA_URL = 'https://raw.githubusercontent.com/visualresistance/gaza4all/main/data/gaza.geojson';
    const WB_URL   = 'https://raw.githubusercontent.com/visualresistance/gaza4all/main/data/west_bank.geojson';

    let gazaTemplate=null, wbTemplate=null, gazaLayer=null, wbLayer=null;
    const STYLE_GAZA = { color:'#ef4444', weight:2, fillOpacity:0.15 };
    const STYLE_WB   = { color:'#3b82f6', weight:2, fillOpacity:0.15 };
    const poiLayer = L.layerGroup(); layerControl.addOverlay(poiLayer, "Schools & Libraries (OSM)");

    const statusEl = document.getElementById('status');
    const setStatus = (m,err=false)=>{ statusEl.textContent=m; statusEl.className='status'+(err?' error':''); };

    async function fetchJSON(url){
      const r = await fetch(url, { cache:'no-store' });
      if(!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`);
      const t = await r.text();
      try { return JSON.parse(t); } catch { throw new Error(`Non-JSON from ${url}. First 120 chars: ${t.slice(0,120)}`); }
    }
    async function ensureTemplates(){
      if(!gazaTemplate){ setStatus('Loading Gaza…'); gazaTemplate = await fetchJSON(GAZA_URL); }
      if(!wbTemplate){   setStatus('Loading West Bank…'); wbTemplate = await fetchJSON(WB_URL); }
      setStatus('Ready');
    }
    function geojsonToLayer(fc, style){
      const layer = L.geoJSON(fc, { style, onEachFeature:(f,lyr)=>{ if(lyr.dragging) lyr.dragging.enable(); } });
      layer.eachLayer(l=>{ if(l.dragging) l.dragging.enable(); });
      return layer;
    }
    function getCenter(fc){ const tmp=L.geoJSON(fc), c=tmp.getBounds().getCenter(); tmp.remove(); return c; }
    function translateFC(fc, dLat, dLng){
      const out=JSON.parse(JSON.stringify(fc));
      function shift(coords){ return (typeof coords[0][0]==='number') ? coords.map(([lng,lat])=>[lng+dLng,lat+dLat]) : coords.map(shift); }
      out.features = out.features.map(feat=>{ const g=feat.geometry; if(g.type==='Polygon'||g.type==='MultiPolygon') g.coordinates=shift(g.coordinates); return feat; });
      return out;
    }
    function placeAtCenter(templateFC, style){
      const mC=map.getCenter(), tC=getCenter(templateFC);
      const moved = translateFC(templateFC, mC.lat - tC.lat, mC.lng - tC.lng);
      return geojsonToLayer(moved, style).addTo(map);
    }

    document.getElementById('btnGaza').addEventListener('click', async ()=>{
      try { await ensureTemplates(); if(gazaLayer) map.removeLayer(gazaLayer);
        gazaLayer = placeAtCenter(gazaTemplate, STYLE_GAZA);
        layerControl.addOverlay(gazaLayer, 'Gaza (draggable)');
        setStatus('Gaza placed'); } catch(e){ setStatus('Failed to load Gaza: '+e.message, true); alert(e.message); }
    });
    document.getElementById('btnWB').addEventListener('click', async ()=>{
      try { await ensureTemplates(); if(wbLayer) map.removeLayer(wbLayer);
        wbLayer = placeAtCenter(wbTemplate, STYLE_WB);
        layerControl.addOverlay(wbLayer, 'West Bank (draggable)');
        setStatus('West Bank placed'); } catch(e){ setStatus('Failed to load West Bank: '+e.message, true); alert(e.message); }
    });

    document.getElementById('btnPOI').addEventListener('click', async ()=>{
      const b = map.getBounds();
      const bbox = [b.getSouth(), b.getWest(), b.getNorth(), b.getEast()].join(',');
      const query = `
        [out:json][timeout:25];
        (node["amenity"="school"](${bbox}); way["amenity"="school"](${bbox}); relation["amenity"="school"](${bbox});
         node["amenity"="library"](${bbox}); way["amenity"="library"](${bbox}); relation["amenity"="library"](${bbox}););
        out center;`;
      try {
        const data = await fetch('https://overpass-api.de/api/interpreter', { method:'POST', body:query, headers:{'Content-Type':'text/plain;charset=UTF-8'} }).then(r=>r.json());
        poiLayer.clearLayers();
        let n=0; for(const el of data.elements){ let lat=el.lat, lon=el.lon; if(!lat&&el.center){lat=el.center.lat; lon=el.center.lon;}
          if(lat&&lon){ const name=el.tags?.name||'(unnamed)'; const type=el.tags?.amenity||''; L.circleMarker([lat,lon],{radius:4}).bindPopup(`<b>${name}</b><br>${type}`).addTo(poiLayer); n++; } }
        if(n===0) return alert('No schools/libraries found in view. Zoom in and try again.');
        poiLayer.addTo(map);
        setStatus(`Loaded ${n} POI`);
      } catch(e){ setStatus('POI load failed: '+e.message, true); alert(e.message); }
    });

    console.log('Using RAW URLs:', GAZA_URL, WB_URL);
  </script>
</body>
</html>



  

